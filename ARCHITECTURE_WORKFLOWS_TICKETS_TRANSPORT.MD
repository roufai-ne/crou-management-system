# ðŸ—ï¸ ARCHITECTURE & WORKFLOWS - Tickets Transport + Situations JournaliÃ¨res CROU

## ðŸ“ Diagramme Architectural Global

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MODULE TRANSPORT CROU - Architecture               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   EXISTANT (Ã€ prÃ©server)          NOUVEAU (Ã€ ajouter)           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                                                                  â”‚
â”‚   âœ… Parc automobile        â”€â”€â”€â”€â”€â”€â–º âŒ Gestion Tickets           â”‚
â”‚   âœ… Journal navettes       â”€â”€â”€â”€â”€â”€â–º âŒ Situations journaliÃ¨res   â”‚
â”‚   âœ… Suivi carburant                                            â”‚
â”‚   âœ… Maintenance                                                â”‚
â”‚   âœ… Dashboard KPI                                              â”‚
â”‚                                                                  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              BASE DE DONNÃ‰ES TRANSPORT                    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Tables EXISTANTES :                                      â”‚  â”‚
â”‚  â”‚ â€¢ parc_automobile (bus, Ã©tat, km, chauffeur)             â”‚  â”‚
â”‚  â”‚ â€¢ navettes (journal de bord quotidien)                   â”‚  â”‚
â”‚  â”‚ â€¢ consommation_carburant (suivi mensuel)                 â”‚  â”‚
â”‚  â”‚ â€¢ maintenance (opÃ©rations)                               â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ Tables Ã€ AJOUTER :                                       â”‚  â”‚
â”‚  â”‚ â€¢ circuits_transport                                     â”‚  â”‚
â”‚  â”‚ â€¢ tarifs_transport                                       â”‚  â”‚
â”‚  â”‚ â€¢ categories_tickets_transport                           â”‚  â”‚
â”‚  â”‚ â€¢ tickets_transport â­                                   â”‚  â”‚
â”‚  â”‚ â€¢ situations_journalieres_transport â­                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       FRONTEND LAYERS                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Pages Ã  AJOUTER :                                               â”‚
â”‚  â”œâ”€ /transport/tickets/emettre          [Ã‰mission tickets]       â”‚
â”‚  â”œâ”€ /transport/tickets/historique       [Consultation]           â”‚
â”‚  â””â”€ /transport/situations               [Situations jour]        â”‚
â”‚                                                                  â”‚
â”‚  Widgets Ã  AJOUTER :                                             â”‚
â”‚  â””â”€ Dashboard Transport [Navettes + Recettes + KPI]             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       API REST ENDPOINTS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  NOUVEAUX ENDPOINTS :                                            â”‚
â”‚  â€¢ POST   /api/transport/tickets                                â”‚
â”‚  â€¢ GET    /api/transport/tickets                                â”‚
â”‚  â€¢ PATCH  /api/transport/tickets/:id/valider                    â”‚
â”‚  â€¢ POST   /api/transport/situations/{date}/generer             â”‚
â”‚  â€¢ GET    /api/transport/situations                             â”‚
â”‚                                                                  â”‚
â”‚  ENDPOINTS EXISTANTS (Ã  lire) :                                 â”‚
â”‚  â€¢ GET    /api/transport/parc-automobile                        â”‚
â”‚  â€¢ GET    /api/transport/navettes                               â”‚
â”‚  â€¢ GET    /api/transport/carburant                              â”‚
â”‚  â€¢ GET    /api/transport/maintenance                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ WORKFLOW 1 : Ã‰mission de Tickets (DÃ©tail complet)

```
[INTERFACE] Formulaire "Ã‰mettre Tickets"
â”‚
â”‚  Utilisateur saisi :
â”‚  â”œâ”€ Date transport : 2025-04-24
â”‚  â”œâ”€ Circuit : Centre â†’ Campus
â”‚  â”œâ”€ Type ticket : RÃ©gulier
â”‚  â””â”€ QuantitÃ© : 50
â”‚
â–¼
[VALIDATION FRONTEND]
â”œâ”€ Date valide & future/aujourd'hui
â”œâ”€ Circuit sÃ©lectionnÃ©
â”œâ”€ QuantitÃ© > 0
â””â”€ Type ticket exists

â–¼ (Si erreur, afficher message)

[RÃ‰CUPÃ‰RATION TARIF]
â”‚
â”‚  GET /api/transport/tarifs?circuit_id=xxx&type_ticket=RÃ©gulier
â”‚  â””â”€ Retourne : prix_unitaire = 500 FCFA
â”‚
â”‚  Calcul : montant_total = 50 Ã— 500 = 25,000 FCFA
â”‚
â–¼
[AFFICHAGE CONFIRMATION]
â”‚
â”‚  âœ“ Prix unitaire : 500 FCFA
â”‚  âœ“ Montant total : 25,000 FCFA
â”‚  
â”‚  [Annuler] [Confirmer Ã‰mission]

â–¼ (User clique [Confirmer])

[API CALL] POST /api/transport/tickets
â”‚
â”‚  Payload:
â”‚  {
â”‚    "circuit_id": "circuit_xyz",
â”‚    "date_transport": "2025-04-24",
â”‚    "categorie_id": "cat_regulier",
â”‚    "quantite": 50,
â”‚    "prix_unitaire": 500,
â”‚    "emis_par": "user_123"
â”‚  }
â”‚
â–¼
[BACKEND PROCESSING]
â”‚
â”‚  1. Validation requÃªte (acl, donnÃ©es)
â”‚  2. Calculer montant_total = 50 Ã— 500
â”‚  3. GÃ©nÃ©rer numero_serie_debut & numero_serie_fin
â”‚     â””â”€ Ex: DB.max_serie = 500 â†’ new serie: 501-550
â”‚  4. CrÃ©er record Ticket
â”‚     â”œâ”€ statut = "Ã‰mis"
â”‚     â”œâ”€ numero_serie_debut = 501
â”‚     â”œâ”€ numero_serie_fin = 550
â”‚     â””â”€ timestamp = now()
â”‚  5. Commit en BD
â”‚  6. Logger action (audit trail)
â”‚
â–¼
[RESPONSE SUCCESS]
â”‚
â”‚  {
â”‚    "success": true,
â”‚    "ticket_id": "ticket_abc123",
â”‚    "numero_serie_debut": 501,
â”‚    "numero_serie_fin": 550,
â”‚    "montant_total": 25000,
â”‚    "statut": "Ã‰mis",
â”‚    "message": "50 tickets Ã©mis avec succÃ¨s"
â”‚  }
â”‚
â–¼
[FRONTEND AFFICHAGE]
â”‚
â”‚  âœ“ 50 tickets Ã©mis (#501-550)
â”‚  Montant: 25,000 FCFA
â”‚  Statut: Ã€ encaisser
â”‚  
â”‚  [TÃ©lÃ©charger liste] [Continuer]

HISTORIQUE AUDIT
â””â”€ User: Agent123, Action: Ã‰mettre tickets (50Ã—RÃ©gulier, 25,000 FCFA)
   Date: 2025-04-24 14:30:15, Reference: ticket_abc123
```

---

## ðŸ”„ WORKFLOW 2 : GÃ©nÃ©ration Situation JournaliÃ¨re

```
TRIGGER : Minuit (automtique) OU Demande manuelle
â”‚
â”‚  Si manuel :
â”‚  [User] Clique "GÃ©nÃ©rer situation du 24/04"
â”‚
â–¼
[API CALL] POST /api/transport/situations/2025-04-24/generer
â”‚
â–¼
[BACKEND : AGRÃ‰GATION DONNÃ‰ES]
â”‚
â”‚  1ï¸âƒ£ NAVETTES DU JOUR
â”‚  â””â”€ GET local navettes WHERE date = 2025-04-24
â”‚     â”œâ”€ nb_navettes = COUNT(*)
â”‚     â”œâ”€ nb_vehicules = COUNT(DISTINCT vehicule_id)
â”‚     â”œâ”€ total_passagers = SUM(nombre_passagers)
â”‚     â”œâ”€ total_km = SUM(distance_km)
â”‚     â””â”€ total_carburant = SUM(carburant_consomme)
â”‚
â”‚  2ï¸âƒ£ TICKETS DU JOUR
â”‚  â””â”€ GET local tickets WHERE date_transport = 2025-04-24
â”‚     â”œâ”€ Par type ticket :
â”‚     â”‚  â”œâ”€ RÃ©gulier : 400 tickets
â”‚     â”‚  â”œâ”€ Ã‰tudiant : 350 tickets
â”‚     â”‚  â”œâ”€ Personnel : 100 tickets
â”‚     â”‚  â””â”€ Gratuit : 0 tickets
â”‚     â”œâ”€ tickets_emis = 850
â”‚     â””â”€ montant_total = 322,500 FCFA
â”‚
â”‚  3ï¸âƒ£ CALCUL KPI
â”‚  â”œâ”€ taux_remplissage_moyen
â”‚  â”‚  = (SUM(nombre_passagers) / SUM(capacite_vehicule)) Ã— 100
â”‚  â”‚  = (850 / 1050) Ã— 100 = 80.95% â†’ 81%
â”‚  â”‚
â”‚  â”œâ”€ taux_disponibilite_flotte
â”‚  â”‚  = (nb_vehicules_disponibles_cejour / total_parc) Ã— 100
â”‚  â”‚  = (3 / 3) Ã— 100 = 100%
â”‚  â”‚
â”‚  â”œâ”€ cout_carburant_journalier
â”‚  â”‚  = total_carburant Ã— prix_carburant_unitaire
â”‚  â”‚  = 47.3 L Ã— 155.5 FCFA/L = 7,355 FCFA
â”‚  â”‚
â”‚  â””â”€ ponctualite_moyenne
â”‚     = (nb_navettes_pontuellas / total_navettes) Ã— 100
â”‚     = (11 / 12) Ã— 100 = 91.67% â†’ 92%
â”‚
â”‚  4ï¸âƒ£ DÃ‰TECTION ANOMALIES
â”‚  â””â”€ Chercher anomalies dans navettes du jour :
â”‚     â”œâ”€ Retards > 15 min ?
â”‚     â”œâ”€ DÃ©passement carburant habituel ?
â”‚     â”œâ”€ Basse disponibilitÃ© (<80%) ?
â”‚     â”œâ”€ Remplissage critique (<50%) ?
â”‚     â””â”€ VÃ©hicules en maintenance ?
â”‚
â”‚  5ï¸âƒ£ CRÃ‰ATION RECORD SITUATION
â”‚  â””â”€ InsÃ©rer dans BD:
â”‚     {
â”‚       "date_situation": "2025-04-24",
â”‚       "nombre_navettes": 12,
â”‚       "nombre_vehicules_utilises": 3,
â”‚       "total_passagers": 850,
â”‚       "total_km": 187.5,
â”‚       "total_carburant": 47.3,
â”‚       "tickets_emis": 850,
â”‚       "montant_recettes": 322500,
â”‚       "taux_remplissage_moyen": 81,
â”‚       "taux_disponibilite_flotte": 100,
â”‚       "cout_carburant_journalier": 7355,
â”‚       "ponctualite_moyenne": 92,
â”‚       "nb_anomalies": 0,
â”‚       "anomalies_detail": [],
â”‚       "statut": "ValidÃ©"
â”‚     }
â”‚
â–¼
[RESPONSE]
â”‚
â”‚  {
â”‚    "success": true,
â”‚    "situation_id": "sit_20250424_xyz",
â”‚    "date": "2025-04-24",
â”‚    "summary": {
â”‚      "navettes": 12,
â”‚      "passagers": 850,
â”‚      "recettes": 322500,
â”‚      "kpi": {
â”‚        "remplissage": 81,
â”‚        "disponibilite": 100,
â”‚        "ponctualite": 92
â”‚      }
â”‚    }
â”‚  }
â”‚
â–¼
[FRONTEND AFFICHAGE]
â”‚
â”‚  âœ“ Situation journaliÃ¨re gÃ©nÃ©rÃ©e
â”‚  
â”‚  [Consulter dÃ©tail] [Exporter PDF] [Exporter Excel]
```

---

## ðŸ“Š WORKFLOW 3 : Consultation Situation JournaliÃ¨re

```
[USER] AccÃ¨de page Situations JournaliÃ¨res
â”‚
â”‚  SÃ©lectionne date : [24/04/2025]
â”‚  Clique [Charger]
â”‚
â–¼
[API CALL] GET /api/transport/situations?date=2025-04-24
â”‚
â–¼
[BACKEND RETOURNE]
â”‚
â”‚  {
â”‚    "situation_id": "sit_20250424_xyz",
â”‚    "date": "2025-04-24",
â”‚    "navettes": {
â”‚      "nombre": 12,
â”‚      "vehicules_utilises": 3,
â”‚      "passagers": 850,
â”‚      "km_total": 187.5,
â”‚      "carburant": 47.3
â”‚    },
â”‚    "tickets": {
â”‚      "regulier": { "quantite": 400, "montant": 200000 },
â”‚      "etudiant": { "quantite": 350, "montant": 87500 },
â”‚      "personnel": { "quantite": 100, "montant": 35000 },
â”‚      "gratuit": { "quantite": 0, "montant": 0 },
â”‚      "total_montant": 322500
â”‚    },
â”‚    "kpi": {
â”‚      "remplissage_percent": 81,
â”‚      "disponibilite_percent": 100,
â”‚      "cout_carburant": 7355,
â”‚      "ponctualite_percent": 92,
â”‚      "rendement_passagers_km": 4.53
â”‚    },
â”‚    "anomalies": []
â”‚  }
â”‚
â–¼
[FRONTEND AFFICHAGE TABLEAU]
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ SITUATION JOURNALIÃˆRE - 24 Avril 2025    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚                                          â”‚
â”‚  â”‚ ðŸ“Š NAVETTES & FRÃ‰QUENTATION             â”‚
â”‚  â”‚ â”œâ”€ Navettes rÃ©alisÃ©es: 12               â”‚
â”‚  â”‚ â”œâ”€ VÃ©hicules utilisÃ©s: 3                â”‚
â”‚  â”‚ â”œâ”€ Passagers transportÃ©s: 850           â”‚
â”‚  â”‚ â”œâ”€ Distance totale: 187.5 km            â”‚
â”‚  â”‚ â””â”€ Carburant consommÃ©: 47.3 L           â”‚
â”‚  â”‚                                          â”‚
â”‚  â”‚ ðŸ’° RECETTES & TICKETS                    â”‚
â”‚  â”‚ â”œâ”€ Tickets Ã©mis: 850                    â”‚
â”‚  â”‚ â”‚  â”œâ”€ RÃ©gulier (400): 200,000 FCFA      â”‚
â”‚  â”‚ â”‚  â”œâ”€ Ã‰tudiant (350): 87,500 FCFA       â”‚
â”‚  â”‚ â”‚  â””â”€ Personnel (100): 35,000 FCFA      â”‚
â”‚  â”‚ â””â”€ Montant total: 322,500 FCFA          â”‚
â”‚  â”‚                                          â”‚
â”‚  â”‚ ðŸ“ˆ KPI JOURNALIER                        â”‚
â”‚  â”‚ â”œâ”€ Taux remplissage: 81% âœ“              â”‚
â”‚  â”‚ â”œâ”€ DisponibilitÃ© flotte: 100% âœ“         â”‚
â”‚  â”‚ â”œâ”€ PonctualitÃ©: 92% âœ“                   â”‚
â”‚  â”‚ â”œâ”€ CoÃ»t carburant: 7,355 FCFA           â”‚
â”‚  â”‚ â””â”€ Rendement: 4.53 pass./km             â”‚
â”‚  â”‚                                          â”‚
â”‚  â”‚ âš ï¸ ANOMALIES: Aucune âœ“                   â”‚
â”‚  â”‚                                          â”‚
â”‚  â”‚ [PDF] [Excel] [Imprimer]                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
[EXPORT PDF]
â”‚
â”‚  AppelÃ© endpoint POST /api/transport/situations/sit_20250424_xyz/export-pdf
â”‚  â”‚
â”‚  â”œâ”€ Utilise template PDF (jsPDF + html2canvas)
â”‚  â”œâ”€ Ajoute : Logo MESRIT/CROU, En-tÃªtes, Tableaux, Graphiques
â”‚  â”œâ”€ GÃ©nÃ¨re PDF en mÃ©moire
â”‚  â””â”€ Retourne : fichier PDF tÃ©lÃ©chargeable
â”‚
â–¼
[EXPORT EXCEL]
â”‚
â”‚  AppelÃ© endpoint POST /api/transport/situations/sit_20250424_xyz/export-excel
â”‚  â”‚
â”‚  â”œâ”€ Utilise SheetJS (xlsx)
â”‚  â”œâ”€ Feuille 1 : DonnÃ©es brutes (tableaux)
â”‚  â”œâ”€ Feuille 2 : Graphiques (si possible)
â”‚  â”œâ”€ Feuille 3 : SynthÃ¨se (KPI)
â”‚  â””â”€ Retourne : fichier XLSX tÃ©lÃ©chargeable
```

---

## âš™ï¸ LOGIQUE DE CALCUL KPI (DÃ©tail)

### 1. Taux de Remplissage Moyen

```javascript
// Formule
taux_remplissage = (total_passagers_jour / capacite_totale_vehicules) Ã— 100

// Exemple :
// Navette 1 : 45 passagers / 70 capacitÃ© = 64%
// Navette 2 : 38 passagers / 70 capacitÃ© = 54%
// Navette 3 : 50 passagers / 70 capacitÃ© = 71%
// ... (12 navettes total)
// 
// Moyenne = (64 + 54 + 71 + ...) / 12 = 81%

// Code
const calculateRemplissageMoyen = (navettes) => {
  const tauxParNavette = navettes.map(n => 
    (n.nombre_passagers / n.vehicule.capacite) * 100
  );
  return Math.round(tauxParNavette.reduce((a,b) => a+b, 0) / navettes.length);
};
```

### 2. Taux de DisponibilitÃ© de Flotte

```javascript
// Formule
disponibilite = (nb_vehicules_utilises_jour / total_parc) Ã— 100

// Exemple :
// Parc total : 3 bus
// UtilisÃ©s jour : 3 bus
// DisponibilitÃ© = (3/3) Ã— 100 = 100%

// Code
const calculateDisponibilite = async (date) => {
  const totalParc = await BD.parc.count();
  const navettesDay = await BD.navettes.distinct('vehicule_id')
    .where({ date_navette: date });
  
  return (navettesDay.length / totalParc) * 100;
};
```

### 3. CoÃ»t Carburant Journalier

```javascript
// Formule
cout_carburant = total_carburant_consomme Ã— prix_carburant_unitaire

// Exemple :
// Carburant consommÃ© : 47.3 L
// Prix unitaire (paramÃ¨tre) : 155.5 FCFA/L
// CoÃ»t = 47.3 Ã— 155.5 = 7,355 FCFA

// Code
const calculateCoutCarburant = async (date) => {
  const config = await BD.parametres_transport.findOne();
  const navettes = await BD.navettes.where({ date_navette: date });
  
  const totalLitres = navettes.reduce((sum, n) => 
    sum + n.carburant_consomme, 0);
  
  return totalLitres * config.prix_carburant_fcfa_par_litre;
};
```

### 4. PonctualitÃ© Moyenne

```javascript
// Formule
ponctualite = (nb_navettes_ponctuelles / total_navettes) Ã— 100
// OÃ¹ "ponctuelle" = retard â‰¤ 15 minutes

// Exemple :
// Total navettes : 12
// Ponctuelles (retard â‰¤ 15min) : 11
// PonctualitÃ© = (11/12) Ã— 100 = 91.67% â†’ 92%

// Code
const calculatePonctualite = (navettes) => {
  const seuilMinutes = 15;
  const ponctuelles = navettes.filter(n => 
    Math.abs(n.ponctualite_minutes) <= seuilMinutes
  );
  return (ponctuelles.length / navettes.length) * 100;
};
```

### 5. Rendement (Passagers/km)

```javascript
// Formule
rendement = total_passagers / total_km

// Exemple :
// Passagers : 850
// Km : 187.5
// Rendement = 850 / 187.5 = 4.53 passagers/km

// Code
const calculateRendement = (navettes) => {
  const totalPassagers = navettes.reduce((sum, n) => 
    sum + n.nombre_passagers, 0);
  const totalKm = navettes.reduce((sum, n) => 
    sum + n.distance_km, 0);
  
  return (totalPassagers / totalKm).toFixed(2);
};
```

---

## ðŸš¨ DÃ‰TECTION ANOMALIES

### RÃ¨gles d'Alerte

```javascript
const detectAnomalies = (situation) => {
  const anomalies = [];
  
  // Alerte 1 : Remplissage trÃ¨s faible
  if (situation.taux_remplissage_moyen < 50) {
    anomalies.push({
      type: "REMPLISSAGE_FAIBLE",
      severity: "WARNING",
      message: `Remplissage faible (${situation.taux_remplissage_moyen}%)`
    });
  }
  
  // Alerte 2 : DisponibilitÃ© basse
  if (situation.taux_disponibilite_flotte < 80) {
    anomalies.push({
      type: "DISPONIBILITE_BASSE",
      severity: "CRITICAL",
      message: `DisponibilitÃ© critique (${situation.taux_disponibilite_flotte}%)`
    });
  }
  
  // Alerte 3 : PonctualitÃ© mauvaise
  if (situation.ponctualite_moyenne < 80) {
    anomalies.push({
      type: "PONCTUALITE_MAUVAISE",
      severity: "WARNING",
      message: `PonctualitÃ© dÃ©gradÃ©e (${situation.ponctualite_moyenne}%)`
    });
  }
  
  // Alerte 4 : Consommation carburant anormale
  const moyenneHisto = 7000; // FCFA (Ã  calibrer)
  if (situation.cout_carburant > moyenneHisto * 1.2) {
    anomalies.push({
      type: "CARBURANT_ELEVE",
      severity: "WARNING",
      message: `Consommation Ã©levÃ©e (${situation.cout_carburant} FCFA)`
    });
  }
  
  // Alerte 5 : Rendement suspect
  const seuil_min = 3; // passagers/km
  if (situation.rendement < seuil_min) {
    anomalies.push({
      type: "RENDEMENT_BAS",
      severity: "INFO",
      message: `Rendement bas (${situation.rendement} pass./km)`
    });
  }
  
  return anomalies;
};
```

---

## ðŸ”— INTÃ‰GRATION AVEC MODULE EXISTANT

### Points de Lecture (API GET)

**1. RÃ©cupÃ©rer Navettes du Jour**
```javascript
// Le systÃ¨me appelle cet endpoint existant
GET /api/transport/navettes?date=2025-04-24

// Retour attendu :
{
  "navettes": [
    {
      "navette_id": "nav_001",
      "date_navette": "2025-04-24",
      "vehicule_id": "veh_bus1",
      "heure_depart": "06:30",
      "heure_arrivee": "07:15",
      "nombre_passagers": 45,
      "km_depart": 5200,
      "km_arrivee": 5215,
      "carburant_consomme": 3.9,
      "ponctualite_minutes": 2  // +2 = 2 min en retard
    },
    { ... }
  ]
}
```

**2. RÃ©cupÃ©rer VÃ©hicules (Parc Automobile)**
```javascript
// Pour calcul disponibilitÃ©
GET /api/transport/parc-automobile?date=2025-04-24

// Retour :
{
  "parc": [
    {
      "vehicule_id": "veh_bus1",
      "designation": "Bus 1",
      "capacite": 70,
      "etat": "Bon Ã©tat",
      "en_maintenance": false,
      "derniere_utilisation": "2025-04-24T17:30:00"
    },
    { ... }
  ]
}
```

**3. RÃ©cupÃ©rer Tarifs Carburant**
```javascript
// Pour calcul coÃ»t carburant
GET /api/transport/parametres

// Retour :
{
  "parametres": {
    "prix_carburant_fcfa_par_litre": 155.5
  }
}
```

---

## ðŸ“Š EXEMPLE DE SITUATION COMPLÃˆTE (JSON)

```json
{
  "situation_id": "sit_20250424_001",
  "date_situation": "2025-04-24",
  "crou": "CROU Niamey",
  "timestamp_generation": "2025-04-24T23:00:00Z",
  
  "navettes": {
    "nombre_total": 12,
    "nombre_vehicules_utilises": 3,
    "detail": [
      {
        "num": 1,
        "vehicule": "Bus 1",
        "circuit": "Centre â†’ Campus",
        "heure_depart": "06:30",
        "heure_arrivee": "07:15",
        "passagers": 45,
        "distance_km": 15.5,
        "carburant": 3.9,
        "taux_remplissage": "64%",
        "retard_minutes": 2
      },
      { ... }
    ],
    "statistiques": {
      "total_passagers": 850,
      "total_km": 187.5,
      "total_carburant_litres": 47.3
    }
  },
  
  "tickets": {
    "par_type": {
      "regulier": {
        "quantite": 400,
        "prix_unitaire": 500,
        "montant": 200000,
        "statut": "ValidÃ©"
      },
      "etudiant": {
        "quantite": 350,
        "prix_unitaire": 250,
        "montant": 87500,
        "statut": "ValidÃ©"
      },
      "personnel": {
        "quantite": 100,
        "prix_unitaire": 350,
        "montant": 35000,
        "statut": "ValidÃ©"
      },
      "gratuit": {
        "quantite": 0,
        "prix_unitaire": 0,
        "montant": 0,
        "statut": "N/A"
      }
    },
    "totaux": {
      "tickets_emis": 850,
      "tickets_valides": 850,
      "tickets_encaisses": 0,
      "montant_total": 322500,
      "montant_encaisse": 0,
      "montant_en_attente": 322500
    }
  },
  
  "kpi": {
    "taux_remplissage_moyen_percent": 81,
    "taux_disponibilite_flotte_percent": 100,
    "cout_carburant_journalier_fcfa": 7355,
    "consommation_moyenne_l_100km": 25.2,
    "ponctualite_moyenne_percent": 92,
    "rendement_passagers_km": 4.53,
    "tendance_vs_hier": {
      "passagers": "+5%",
      "recettes": "+8%",
      "carburant": "-2%"
    }
  },
  
  "anomalies": [],
  
  "statut": "ValidÃ©",
  "validÃ©_par": "admin_transport",
  "date_validation": "2025-04-24T23:05:00Z"
}
```

---

## âœ… CHECKLIST D'INTÃ‰GRATION

- [ ] AccÃ¨s API navettes confirmÃ© + testÃ©e
- [ ] AccÃ¨s parc automobile confirmÃ©
- [ ] Tarifs carburant paramÃ©trisables
- [ ] Migrations BD en place
- [ ] Seed data (circuits, tarifs) chargÃ©e
- [ ] Tests API tickets fonctionnels
- [ ] Tests gÃ©nÃ©ration situation OK
- [ ] Exports PDF/Excel gÃ©nÃ©rÃ©s correctement
- [ ] Dashboard widget intÃ©grÃ©
- [ ] Permissions et rÃ´les configurÃ©s
- [ ] Audit trail fonctionnel

---

**Document gÃ©nÃ©rÃ© le** : 2025-04-24
**Version** : 1.0
**Scope** : Architecture Tickets + Situations (Module Transport)