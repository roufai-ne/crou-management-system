# ğŸ¤– GUIDE DE COORDINATION POUR AGENTS IA
## Ajout Tickets de Transport + Situations JournaliÃ¨res CROU

---

## ğŸ“‹ CONTEXTE EXÃ‰CUTIF

**Projet** : Ajout gestion tickets + situations journaliÃ¨res au module Transport CROU (existant)
**Client** : Roufai (MESRIT - Niger)
**Scope** : Petit ajout (pas complet refactor) - Focus: Tickets + Reports journaliers
**Budget Temps** : ~4-5 semaines (phases courtes)
**PrioritÃ©** : Moyenne-Haute - AmÃ©liore tracking financier + opÃ©rationnel

---

## ğŸ¯ OBJECTIFS

1. âœ… Permettre Ã©mission de **tickets de transport** (batch ou unitaire)
2. âœ… Tracker les **recettes** par type de ticket
3. âœ… GÃ©nÃ©rer **situation journaliÃ¨re** consolidÃ©e (navettes + tickets + KPI)
4. âœ… Exporter rapports (PDF/Excel)
5. âœ… IntÃ©grer fluide avec **module Transport existant** (parc, navettes, carburant)

---

## ğŸ§© MODULES Ã€ IMPLÃ‰MENTER (Ordre RecommandÃ©)

### MODULE 1 : Base de DonnÃ©es (0.5 sem)
**ResponsabilitÃ©** : Ajouter tables pour tickets + situations

**Livrables** :
- [ ] Table `circuits_transport` (routes/parcours)
- [ ] Table `tarifs_transport` (prix par circuit + type)
- [ ] Table `categories_tickets_transport` (types tickets)
- [ ] Table `tickets_transport` (tickets Ã©mis)
- [ ] Table `situations_journalieres_transport` (agrÃ©gation jour)

**Files** :
```
src/migrations/
â”œâ”€â”€ 2025-04-24-001-add-circuits.sql
â”œâ”€â”€ 2025-04-24-002-add-tarifs.sql
â”œâ”€â”€ 2025-04-24-003-add-tickets.sql
â””â”€â”€ 2025-04-24-004-add-situations.sql

src/models/
â”œâ”€â”€ Circuit.js
â”œâ”€â”€ Tarif.js
â”œâ”€â”€ CategorieTicket.js
â”œâ”€â”€ Ticket.js
â””â”€â”€ SituationJournaliere.js
```

**Acceptance** :
- âœ… Toutes tables crÃ©Ã©es avec FK correct
- âœ… Seed data : tarifs CROU + circuits (paramÃ©trage initial)

---

### MODULE 2 : API Circuits & Tarifs (0.5 sem)
**ResponsabilitÃ©** : CRUD pour paramÃ©trage

**Endpoints** :
```javascript
// Circuits
GET    /api/transport/circuits
POST   /api/transport/circuits
PUT    /api/transport/circuits/:id
DELETE /api/transport/circuits/:id

// Tarifs
GET    /api/transport/tarifs?circuit_id=xxx
POST   /api/transport/tarifs
PUT    /api/transport/tarifs/:id
DELETE /api/transport/tarifs/:id

// CatÃ©gories Tickets
GET    /api/transport/categories-tickets
POST   /api/transport/categories-tickets
```

**Logique** :
- Circuits = routes (Centre â†’ Campus, Campus A â†’ B, etc.)
- Tarifs = prix par circuit + type ticket
- CatÃ©gories = RÃ©gulier, Ã‰tudiant, Personnel, Gratuit, etc.

**Tests** :
```javascript
test('CRUD circuits avec validation');
test('Tarifs CRUD avec FK vers circuit');
test('CatÃ©gories CRUD avec prix');
```

**Acceptance** :
- âœ… API 100% fonctionnelle
- âœ… Validation stricte (prix > 0, dates valides)
- âœ… Retours d'erreur explicites

---

### MODULE 3 : API Ã‰mission de Tickets (1 sem)
**ResponsabilitÃ©** : Logique Ã©mission tickets avec validation

**Endpoints** :
```javascript
GET    /api/transport/tickets?date_from=&date_to=&circuit=&statut=
POST   /api/transport/tickets                    // Ã‰mettre tickets
GET    /api/transport/tickets/:ticket_id
PATCH  /api/transport/tickets/:ticket_id/valider
PATCH  /api/transport/tickets/:ticket_id/encaisser
DELETE /api/transport/tickets/:ticket_id        // Soft-delete (annulation)
```

**Logique d'Ã©mission** :
```javascript
// POST /api/transport/tickets
1. Valider input :
   - circuit_id exists
   - date_transport valide
   - categorie_id exists
   - quantite > 0
   
2. RÃ©cupÃ©rer tarif :
   - SELECT prix_unitaire FROM tarifs
     WHERE circuit_id = ? AND type_ticket = ?
   
3. Calculer montant_total = quantite Ã— prix
   
4. GÃ©nÃ©rer numÃ©ros de sÃ©rie :
   - numero_serie_debut = MAX(numero_serie_fin) + 1
   - numero_serie_fin = inicio + quantite - 1
   
5. CrÃ©er record Ticket :
   - INSERT INTO tickets_transport
     (..., numero_serie_debut, numero_serie_fin, statut='Ã‰mis')
   
6. Retourner succÃ¨s + dÃ©tails
```

**Validations** :
- Circuit doit exister
- Type ticket doit exister
- QuantitÃ© > 0 et < 10000 (limit raisonnable)
- Pas deux tickets mÃªme circuit + date + cat (business rule ?)

**Tests** :
```javascript
describe('TicketAPI - Ã‰mission', () => {
  test('Ã‰mettre 50 tickets rÃ©guliers');
  test('Calcul montant correct');
  test('NumÃ©rotation sÃ©rie continue');
  test('Reject quantitÃ© invalide');
  test('Reject circuit inexistant');
});
```

**Acceptance** :
- âœ… Ã‰mission batch simple & fiable
- âœ… NumÃ©rotation automatique
- âœ… Montants calculÃ©s correctement
- âœ… Validation stricte

---

### MODULE 4 : API Situations JournaliÃ¨res (1 sem)
**ResponsabilitÃ©** : GÃ©nÃ©ration + agrÃ©gation donnÃ©es

**Endpoints** :
```javascript
GET    /api/transport/situations?date=&mois=&annee=
POST   /api/transport/situations/{date}/generer
GET    /api/transport/situations/:situation_id
PATCH  /api/transport/situations/:situation_id/valider
```

**Logique gÃ©nÃ©ration** :

```javascript
// POST /api/transport/situations/2025-04-24/generer
async function generateSituation(date) {
  //1ï¸âƒ£ NAVETTES DU JOUR
  const navettes = await DB.navettes.where({ date_navette: date });
  
  const stats_navettes = {
    nombre: navettes.length,
    vehicules: new Set(navettes.map(n => n.vehicule_id)).size,
    passagers: navettes.reduce((sum, n) => sum + n.nombre_passagers, 0),
    km_total: navettes.reduce((sum, n) => sum + n.distance_km, 0),
    carburant: navettes.reduce((sum, n) => sum + n.carburant_consomme, 0)
  };
  
  // 2ï¸âƒ£ TICKETS DU JOUR
  const tickets = await DB.tickets.where({ date_transport: date });
  
  const stats_tickets = {
    emis: tickets.length,
    par_type: groupBy(tickets, 'categorie_id'),
    montant_total: tickets.reduce((sum, t) => sum + t.montant_total, 0)
  };
  
  // 3ï¸âƒ£ CALCUL KPI
  const kpi = {
    remplissage: calculateRemplissage(navettes),
    disponibilite: await calculateDisponibilite(date),
    carburant_cost: stats_navettes.carburant * 155.5,  // Prix unitaire
    ponctualite: calculatePonctualite(navettes),
    rendement: stats_navettes.passagers / stats_navettes.km_total
  };
  
  // 4ï¸âƒ£ DÃ‰TECTION ANOMALIES
  const anomalies = detectAnomalies(kpi, stats_navettes);
  
  // 5ï¸âƒ£ SAUVEGARDE
  const situation = await DB.situations.create({
    date_situation: date,
    nombre_navettes: stats_navettes.nombre,
    nombre_vehicules_utilises: stats_navettes.vehicules,
    total_passagers: stats_navettes.passagers,
    total_km: stats_navettes.km_total,
    total_carburant: stats_navettes.carburant,
    tickets_emis: stats_tickets.emis,
    montant_recettes: stats_tickets.montant_total,
    taux_remplissage_moyen: kpi.remplissage,
    taux_disponibilite_flotte: kpi.disponibilite,
    cout_carburant_journalier: kpi.carburant_cost,
    ponctualite_moyenne: kpi.ponctualite,
    nb_anomalies: anomalies.length,
    anomalies_detail: anomalies,
    statut: 'ValidÃ©'
  });
  
  return situation;
}
```

**Tests** :
```javascript
describe('SituationAPI - GÃ©nÃ©ration', () => {
  test('AgrÃ¨ge navettes correctement');
  test('AgrÃ¨ge tickets correctement');
  test('Calcule KPI exactement');
  test('DÃ©tecte anomalies');
  test('Persiste en BD');
});
```

**Acceptance** :
- âœ… DonnÃ©es agrÃ©gÃ©es exactes
- âœ… KPI calculÃ©s correctement (voir formules architecture doc)
- âœ… Anomalies dÃ©tectÃ©es OK
- âœ… Situation persiste en BD

---

### MODULE 5 : Frontend - Interfaces (1 sem)
**ResponsabilitÃ©** : Pages React/Next.js

**Pages Ã  crÃ©er** :

```
src/pages/transport/
â”œâ”€â”€ tickets/
â”‚  â”œâ”€â”€ emettre.js        // Formulaire Ã©mission
â”‚  â””â”€â”€ historique.js     // Tableau + filtres
â”œâ”€â”€ situations/
â”‚  â”œâ”€â”€ index.js          // Liste situations
â”‚  â””â”€â”€ [date].js         // DÃ©tail situation
â””â”€â”€ parametres/
   â”œâ”€â”€ circuits.js       // CRUD circuits
   â”œâ”€â”€ tarifs.js         // CRUD tarifs
   â””â”€â”€ categories.js     // CRUD catÃ©gories
```

**Composants clÃ©s** :

#### 1. TicketEmissionForm.jsx
```jsx
export const TicketEmissionForm = () => {
  const [circuit, setCircuit] = useState();
  const [date, setDate] = useState(new Date());
  const [categorie, setCategorie] = useState('RÃ©gulier');
  const [quantite, setQuantite] = useState(50);
  const [prix, setPrix] = useState();

  // Charger tarif quand circuit change
  useEffect(() => {
    if (!circuit || !categorie) return;
    API.get(`/tarifs?circuit=${circuit}&type=${categorie}`)
      .then(data => setPrix(data.prix_unitaire))
      .catch(err => showError(err.message));
  }, [circuit, categorie]);

  const montant_total = (quantite || 0) * (prix || 0);

  const handleEmettre = async () => {
    if (!confirm(`Ã‰mettre ${quantite} tickets pour ${montant_total} FCFA ?`)) return;

    try {
      const response = await API.post('/tickets', {
        circuit_id: circuit,
        date_transport: date,
        categorie_id: categorie,
        quantite
      });

      showSuccess(`âœ“ ${response.data.quantite} tickets Ã©mis (#${response.data.numero_serie_debut}-${response.data.numero_serie_fin})`);
      // Reset form
      setQuantite(50);
    } catch (err) {
      showError(err.message);
    }
  };

  return (
    <form>
      <label>Circuit</label>
      <select value={circuit} onChange={(e) => setCircuit(e.target.value)}>
        <option>SÃ©lectionner circuit</option>
        {/* Options */}
      </select>

      <label>Date transport</label>
      <input type="date" value={date} onChange={(e) => setDate(e.target.value)} />

      <label>Type ticket</label>
      <select value={categorie} onChange={(e) => setCategorie(e.target.value)}>
        <option value="RÃ©gulier">RÃ©gulier</option>
        <option value="Ã‰tudiant">Ã‰tudiant</option>
        <option value="Personnel">Personnel</option>
      </select>

      <label>Prix unitaire</label>
      <input type="number" disabled value={prix || 0} />

      <label>QuantitÃ©</label>
      <input type="number" value={quantite} onChange={(e) => setQuantite(parseInt(e.target.value))} />

      <div className="total">
        <strong>Montant total: {montant_total} FCFA</strong>
      </div>

      <button type="button" onClick={handleEmettre}>
        Ã‰mettre Tickets
      </button>
    </form>
  );
};
```

#### 2. SituationDisplay.jsx
```jsx
export const SituationDisplay = ({ date }) => {
  const [situation, setSituation] = useState();
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    API.get(`/situations?date=${date}`)
      .then(data => setSituation(data))
      .catch(err => showError(err.message))
      .finally(() => setLoading(false));
  }, [date]);

  if (loading) return <Spinner />;
  if (!situation) return <p>Aucune situation pour cette date</p>;

  return (
    <div className="situation-display">
      <h2>Situation du {date}</h2>

      <Section title="ğŸ“Š Navettes">
        <Metric label="Navettes rÃ©alisÃ©es" value={situation.nombre_navettes} />
        <Metric label="VÃ©hicules utilisÃ©s" value={situation.nombre_vehicules_utilises} />
        <Metric label="Passagers" value={situation.total_passagers} />
        <Metric label="Distance" value={situation.total_km + ' km'} />
        <Metric label="Carburant" value={situation.total_carburant + ' L'} />
      </Section>

      <Section title="ğŸ’° Tickets & Recettes">
        <Metric label="Tickets Ã©mis" value={situation.tickets_emis} />
        <Metric label="Montant total" value={situation.montant_recettes + ' FCFA'} />
      </Section>

      <Section title="ğŸ“ˆ KPI">
        <Metric label="Remplissage moyen" value={situation.taux_remplissage_moyen + '%'} />
        <Metric label="DisponibilitÃ© flotte" value={situation.taux_disponibilite_flotte + '%'} />
        <Metric label="PonctualitÃ©" value={situation.ponctualite_moyenne + '%'} />
        <Metric label="CoÃ»t carburant" value={situation.cout_carburant_journalier + ' FCFA'} />
      </Section>

      {situation.anomalies.length > 0 && (
        <Section title="âš ï¸ Anomalies">
          {situation.anomalies.map((a, i) => (
            <Alert key={i} type={a.severity} message={a.message} />
          ))}
        </Section>
      )}

      <div className="actions">
        <button onClick={() => exportPDF(situation)}>ğŸ“„ PDF</button>
        <button onClick={() => exportExcel(situation)}>ğŸ“Š Excel</button>
        <button onClick={() => window.print()}>ğŸ–¨ï¸ Imprimer</button>
      </div>
    </div>
  );
};
```

#### 3. Dashboard Widget
```jsx
export const TransportWidget = () => {
  const [today, setToday] = useState();
  
  useEffect(() => {
    API.get(`/situations?date=${new Date().toISOString().split('T')[0]}`)
      .then(data => setToday(data))
      .catch(() => {});
  }, []);

  if (!today) return null;

  return (
    <div className="widget-transport">
      <h3>ğŸšŒ Transport Aujourd'hui</h3>
      <div className="metrics">
        <div>
          <span className="label">Navettes</span>
          <span className="value">{today.nombre_navettes}</span>
        </div>
        <div>
          <span className="label">Passagers</span>
          <span className="value">{today.total_passagers}</span>
        </div>
        <div>
          <span className="label">Recettes</span>
          <span className="value">{today.montant_recettes} FCFA</span>
        </div>
        <div>
          <span className="label">Ã‰tat</span>
          <span className="value" style={{color: today.nb_anomalies === 0 ? 'green' : 'red'}}>
            {today.nb_anomalies === 0 ? 'âœ“ Normal' : 'âš ï¸ Alertes'}
          </span>
        </div>
      </div>
    </div>
  );
};
```

**Acceptance** :
- âœ… Formulaires fonctionnels
- âœ… Tableaux affichent donnÃ©es exactes
- âœ… Exports gÃ©nÃ©rÃ©s correctement

---

### MODULE 6 : Exports PDF & Excel (0.5 sem)
**ResponsabilitÃ©** : GÃ©nÃ©ration rapports

**Endpoints** :
```javascript
POST   /api/transport/situations/:situation_id/export-pdf
POST   /api/transport/situations/:situation_id/export-excel
```

**PDF (jsPDF)** :
```javascript
export async function generateSituationPDF(situation) {
  const doc = new jsPDF();
  
  // En-tÃªte
  doc.setFontSize(16);
  doc.text('SITUATION JOURNALIÃˆRE TRANSPORT', 20, 20);
  doc.setFontSize(10);
  doc.text(`Date: ${situation.date_situation}`, 20, 30);
  
  // Sections
  let y = 40;
  
  // Navettes
  doc.setFont(undefined, 'bold');
  doc.text('NAVETTES DU JOUR', 20, y);
  y += 8;
  doc.setFont(undefined, 'normal');
  doc.text(`Navettes rÃ©alisÃ©es: ${situation.nombre_navettes}`, 25, y);
  y += 6;
  doc.text(`Passagers: ${situation.total_passagers}`, 25, y);
  y += 6;
  doc.text(`Distance: ${situation.total_km} km`, 25, y);
  y += 10;
  
  // Tickets
  doc.setFont(undefined, 'bold');
  doc.text('TICKETS & RECETTES', 20, y);
  y += 8;
  doc.setFont(undefined, 'normal');
  doc.text(`Tickets Ã©mis: ${situation.tickets_emis}`, 25, y);
  y += 6;
  doc.text(`Montant total: ${situation.montant_recettes} FCFA`, 25, y);
  y += 10;
  
  // KPI
  doc.setFont(undefined, 'bold');
  doc.text('INDICATEURS', 20, y);
  y += 8;
  doc.setFont(undefined, 'normal');
  const kpis = [
    `Remplissage: ${situation.taux_remplissage_moyen}%`,
    `DisponibilitÃ©: ${situation.taux_disponibilite_flotte}%`,
    `PonctualitÃ©: ${situation.ponctualite_moyenne}%`,
    `CoÃ»t carburant: ${situation.cout_carburant_journalier} FCFA`
  ];
  kpis.forEach(kpi => {
    doc.text(kpi, 25, y);
    y += 6;
  });
  
  // Signature
  y += 10;
  doc.text('GÃ©nÃ©rÃ© le: ' + new Date().toLocaleString('fr-FR'), 20, y);
  
  return doc.output('blob');
}
```

**Excel (SheetJS)** :
```javascript
export async function generateSituationExcel(situation) {
  const workbook = XLSX.utils.book_new();
  
  // Feuille 1: DonnÃ©es
  const data = [
    ['SITUATION JOURNALIÃˆRE TRANSPORT', '', situation.date_situation],
    [],
    ['MÃ©trique', 'Valeur'],
    ['Navettes rÃ©alisÃ©es', situation.nombre_navettes],
    ['VÃ©hicules utilisÃ©s', situation.nombre_vehicules_utilises],
    ['Passagers', situation.total_passagers],
    ['Distance (km)', situation.total_km],
    ['Carburant (L)', situation.total_carburant],
    [],
    ['Tickets Ã©mis', situation.tickets_emis],
    ['Montant recettes (FCFA)', situation.montant_recettes],
    [],
    ['Taux remplissage (%)', situation.taux_remplissage_moyen],
    ['DisponibilitÃ© (%)', situation.taux_disponibilite_flotte],
    ['PonctualitÃ© (%)', situation.ponctualite_moyenne],
    ['CoÃ»t carburant (FCFA)', situation.cout_carburant_journalier]
  ];
  
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(workbook, ws, 'Situation');
  
  return XLSX.write(workbook, { bookType: 'xlsx', type: 'blob' });
}
```

**Acceptance** :
- âœ… PDF gÃ©nÃ©rÃ© avec mise en forme
- âœ… Excel avec donnÃ©es brutes + formattage
- âœ… Fichiers tÃ©lÃ©chargeables

---

### MODULE 7 : IntÃ©gration & Dashboard (0.5 sem)
**ResponsabilitÃ©** : Mise ensemble + widget dashboard

**Livrables** :
- [ ] Widget transport ajoutÃ© au dashboard principal
- [ ] Liens navettes â†” situations OK
- [ ] API stock existante testÃ©e + intÃ©grÃ©e
- [ ] Permissions/rÃ´les configurÃ©s
- [ ] Monitoring logs activÃ©

**Acceptance** :
- âœ… Dashboard affiche widget transport
- âœ… Situations gÃ©nÃ©rÃ©es automatiquement (minuit)
- âœ… Toutes intÃ©grations testÃ©es
- âœ… Pas de donnÃ©es orphelines

---

## ğŸ§ª STRATÃ‰GIE DE TEST

### Tests Unitaires (60% du temps)
```javascript
// Calculs
test('Taux remplissage = (passagers/capacitÃ©)*100');
test('CoÃ»t carburant = litres Ã— prix');
test('PonctualitÃ© = (ponctuelles/total)*100');

// Validations
test('QuantitÃ© ticket > 0');
test('Prix > 0');
test('Dates valides');

// Logique mÃ©tier
test('NumÃ©rotation sÃ©rie continue');
test('Statut transition : Ã‰mis â†’ ValidÃ© â†’ EncaissÃ©');
```

### Tests IntÃ©gration (30%)
```javascript
// Workflows
test('Ã‰mettre tickets â†’ vÃ©rif DB');
test('GÃ©nÃ©rer situation â†’ agrÃ©g OK');
test('Export PDF â†’ fichier gÃ©nÃ©rÃ©');

// Avec module existant
test('Fetch navettes â†’ calculs corrects');
test('Fetch parc â†’ disponibilitÃ© OK');
```

### Tests Manuels (10% - UAT avec Roufai)
```
- Ã‰mettre 50 tickets, vÃ©rifier montant
- GÃ©nÃ©rer situation, vÃ©rifier KPI exactitude
- Export PDF/Excel, vÃ©rifier format
- Dashboard affiche donnÃ©es jour
```

---

## ğŸ“… TIMELINE FINALE

| Phase | DurÃ©e | Modules | 
|-------|-------|---------|
| **1: BD + API Base** | 1 sem | Modules 1-2 |
| **2: Tickets** | 1 sem | Module 3 |
| **3: Situations** | 1 sem | Module 4 |
| **4: Frontend** | 1 sem | Module 5 |
| **5: Exports + Polish** | 0.5 sem | Module 6-7 |
| **6: Tests & UAT** | 0.5 sem | All |

**Total: ~4.5 semaines**

---

## ğŸš¨ RISQUES & MITIGATION

| Risque | ProbabilitÃ© | Impact | Mitigation |
|--------|-------------|--------|-----------|
| API navettes indispo | Bas | Moyen | Mock data early, tests indep. |
| Calculs KPI inexacts | Moyen | Ã‰levÃ© | Double-vÃ©rif formules, tests |
| Performance agrÃ©g grosse volume | Bas | Moyen | Index BD, pagination, caching |
| Export timeout (gros PDF) | Bas | Bas | GÃ©nÃ©rer en background |

---

## ğŸ DELIVERABLES FINAUX

```
â”œâ”€ Code (GitHub)
â”‚  â”œâ”€ API (Express/FastAPI)
â”‚  â”œâ”€ Frontend (React/Next.js)
â”‚  â””â”€ Tests
â”œâ”€ Documentation
â”‚  â”œâ”€ README
â”‚  â”œâ”€ API Swagger
â”‚  â””â”€ Diagrammes
â”œâ”€ Database
â”‚  â”œâ”€ Migrations
â”‚  â””â”€ Seed data
â””â”€ Rapports
   â”œâ”€ Templates PDF
   â””â”€ Export Excel
```

---

## âœ… CHECKLIST PRE-LANCEMENT

- [ ] AccÃ¨s API navettes testÃ©
- [ ] Tarifs CROU confirmÃ©s + seed data
- [ ] Stack tech dÃ©cidÃ©e
- [ ] Repo crÃ©Ã©
- [ ] BD dev setup OK
- [ ] Design UI approuvÃ©
- [ ] Team familiarisÃ©e
- [ ] Plan backup en place

---

**PrÃªt Ã  implÃ©menter ! ğŸš€**

*Document gÃ©nÃ©rÃ© le : 2025-04-24*
*Version : 1.0*
*Scope : Ajout Tickets + Situations (Module Transport)*