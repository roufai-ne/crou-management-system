# üìã PROMPT : Int√©gration Module Gestion de Restauration CROU

## üéØ Contexte & Objectif Global

**Syst√®me** : Plateforme de gestion des Centres R√©gionaux des ≈íuvres Universitaires (CROU) - Niger
**Module** : Gestion de la Restauration (int√©gration avec module Stock existant)
**Objectif** : Cr√©er un syst√®me complet permettant de :
- G√©rer les menus vari√©s du CROU (Petit d√©jeuner, D√©jeuner, D√Æner)
- Suivre les besoins quotidiens avec d√©duction du stock valid√©e manuellement
- G√©rer les tickets de restauration par cat√©gories
- G√©n√©rer des rapports de fr√©quentation et financiers
- Exporter les donn√©es en PDF et Excel
- Int√©grer les donn√©es avec les modules existants (Stock, Comptabilit√©, Finances)

**Devise** : FCFA | **Localisation** : Niger

---

## üìä SP√âCIFICATIONS FONCTIONNELLES

### 1. GESTION DES MENUS

#### 1.1 Structure des Menus
- **Champs principaux** :
  - `menu_id` (UUID)
  - `nom_menu` (string, ex: "Riz + Sauce arachide")
  - `type_service` (ENUM: Petit_D√©jeuner, D√©jeuner, D√Æner)
  - `date_application` (DATE)
  - `statut` (ENUM: Actif, Inactif, Planifi√©)
  - `description` (text optionnel)

#### 1.2 Composition du Menu
- **Tableau de d√©tails** : Lier chaque menu √† une liste de produits du stock
  - Produit (r√©f√©rence au stock)
  - Quantit√©_unitaire (kg, litres, nombre)
  - Unit√©_mesure (kg, litre, portion, etc.)
  - Co√ªt_unitaire (synchronis√© du stock)
  - Total_co√ªt (quantit√© √ó co√ªt)

#### 1.3 Menus Vari√©s
- Permettre **plusieurs menus par type de service** sur une m√™me date
- Exemple : Lundi d√©jeuner ‚Üí Menu A (Riz) OU Menu B (P√¢tes)
- **Variation par calendrier** : Plannifier des menus diff√©rents sur plusieurs semaines/mois
- Interface : Calendrier visuel avec menus assign√©s par jour et service

#### 1.4 Gestion des Variations
- Permettre **diff√©rents menus** pour une m√™me date/service (variantes)
- Statut de disponibilit√© pour chaque variante

---

### 2. GESTION DES TICKETS & CAT√âGORIES

#### 2.1 Cat√©gories de Tickets
- **Champs** :
  - `categorie_ticket_id` (UUID)
  - `nom_categorie` (string, ex: "Ticket r√©gulier", "Ticket r√©duit", "Ticket personnel")
  - `type_service` (ENUM: Petit_D√©jeuner, D√©jeuner, D√Æner)
  - `prix_unitaire` (FCFA)
  - `statut` (Actif, Inactif)
  - `description` (optionnel)

#### 2.2 Tickets de Restauration
- **Champs** :
  - `ticket_id` (UUID)
  - `date_emission` (DATETIME)
  - `categorie_ticket_id` (FK)
  - `type_service` (ENUM)
  - `quantite` (nombre de tickets √©mis)
  - `prix_unitaire` (synchronis√© de cat√©gorie)
  - `montant_total` (quantite √ó prix)
  - `statut_validation` (Non valid√©, Valid√©, Encaiss√©)
  - `date_consommation` (DATE, peut √™tre diff√©rente de date_emission)
  - `emis_par` (user_id)
  - `notes` (optionnel)

#### 2.3 Gestion des Gratuit√©s
- Cat√©gorie de tickets sp√©ciale : **"Gratuit"** avec prix_unitaire = 0
- Tra√ßabilit√© via `numero_serie` ou `code_beneficiaire` (optionnel)
- Rapports distinguant tickets payants vs gratuits

---

### 3. BESOINS QUOTIDIENS & D√âDUCTION DE STOCK

#### 3.1 Fiche de Besoins Quotidiens
- **Champs** :
  - `besoin_id` (UUID)
  - `date` (DATE)
  - `type_service` (ENUM)
  - `menu_id` (FK)
  - `nombre_rationnaires_prevus` (nombre)
  - `statut` (Brouillon, Valid√©, Stock d√©duit, Consomm√©)

#### 3.2 D√©tails des Besoins
- **Tableau dynamique** :
  - Produit_id (FK vers Stock)
  - Ration_unitaire (kg/portion/etc par rationnaire)
  - Quantite_totale = nombre_rationnaires √ó ration_unitaire
  - Stock_disponible (synchronis√©)
  - Suffisance (Stock_disponible ‚â• Quantite_totale) ‚Üí Statut: OK ou Insuffisant

#### 3.3 D√©duction du Stock (Processus)
1. **√âtape 1** : Agent de restauration remplit la fiche (menu, nombre de rationnaires, date)
2. **√âtape 2** : Le syst√®me calcule automatiquement les besoins en fonction du menu
3. **√âtape 3** : Comparaison avec stock disponible ‚Üí Afficher les statuts
4. **√âtape 4** : **BOUTON "Valider & D√©duire du Stock"** ‚Üí N√©cessite confirmation
5. **√âtape 5** : Appel API vers module Stock ‚Üí Mettre √† jour les quantit√©s
6. **Historique** : Garder trace des d√©ductions avec timestamps

#### 3.4 Gestion des Anomalies
- **Stock insuffisant** : Afficher avertissement, permettre de :
  - R√©duire le nombre de rationnaires
  - Modifier le menu
  - Confirmer quand m√™me (avec trace)
- **Produit non trouv√© en stock** : Notification, possibilit√© d'ajouter √† demande d'achat

---

### 4. SUIVI DE CONSOMMATION & PERTES

#### 4.1 Enregistrement de la Consommation
- **Fiche de consommation** (apr√®s service) :
  - `consommation_id` (UUID)
  - `besoin_id` (FK)
  - `date` (DATE)
  - `type_service` (ENUM)
  - `nombre_rationnaires_servis` (nombre)
  - `statut` (Servi, Non servi, Partiellement servi)

#### 4.2 Gestion des Pertes/Produits P√©rim√©s
- **Champs additionnels** :
  - `perte_id` (UUID)
  - `date_constatation` (DATETIME)
  - `produit_id` (FK Stock)
  - `quantite_perdue` (nombre)
  - `motif` (ENUM: P√©rim√©, Gaspillage, D√©t√©rioration, Autre)
  - `date_peremption` (si applicable)
  - `description_detaillee` (text)
  - `photograph` (optionnel, pour tra√ßabilit√©)
  - `value_fcfa` (quantit√© √ó prix unitaire du moment)

#### 4.3 Synchronisation Stock pour Pertes
- Les pertes doivent **mettre √† jour automatiquement** le stock via API
- Cat√©gorie de mouvement : "Perte/Gaspillage"
- Historique complet dans le module Stock

---

### 5. GESTION FINANCI√àRE & RAPPORTS

#### 5.1 Synchronisation avec Module Comptabilit√©/Finances
- **Export donn√©es** : 
  - Total recettes par type de service (journali√®re, mensuelle)
  - Ventilation tickets payants vs gratuits
  - Montants encaissables (tickets valid√©s)
- **API** : Webhook ou endpoint pour transmettre donn√©es comptables
- **R√©conciliation** : Comparaison tickets √©mis vs encaissements

#### 5.2 Rapports de Situation

**Rapport Journalier** :
- Date
- Par type de service (Petit d√©j, D√©jeuner, D√Æner) :
  - Tickets vendus (par cat√©gorie)
  - Tickets gratuits
  - Total consommateurs
  - Recettes (FCFA)
  - Menu servi
  - Pertes constat√©es
- Format : Tableau synth√©tique avec totaux

**Rapport Mensuel** :
- Synth√®se par semaine
- Moyennes par jour
- √âvolution vs mois pr√©c√©dent (en %)
- Total recettes mois
- Produits les plus consomm√©s
- Taux de gaspillage

**Rapport Annuel** :
- Synth√®se par mois
- Tendances annuelles
- Comparaisons par trimestre
- Analyse co√ªts vs recettes

#### 5.3 Tableaux de Bord
- **Widget Restauration** (√† ajouter aux dashboards existants) :
  - Fr√©quentation du jour (temps r√©el)
  - Recettes du jour
  - Ruptures de stock anticip√©es
  - Pertes du jour
  - √âtat g√©n√©ral (vert/orange/rouge)
- **Vue mensuelle** : Graphiques de fr√©quentation, recettes, √©volution

---

### 6. INT√âGRATIONS SYST√àME

#### 6.1 Int√©gration Module Stock
- **Appels API** :
  - `GET /api/stock/produits` ‚Üí R√©cup√©rer produits disponibles
  - `GET /api/stock/produits/{id}/disponibilite` ‚Üí Quantit√© disponible
  - `POST /api/stock/mouvements` ‚Üí Cr√©er mouvement de d√©duction
    ```json
    {
      "type_mouvement": "Consommation_Restauration",
      "produit_id": "xxx",
      "quantite": 50,
      "unite": "kg",
      "reference_restauration": "besoin_id_xyz",
      "date": "2025-04-24",
      "motif": "Besoins quotidiens valid√©s"
    }
    ```
  - `POST /api/stock/mouvements` (Pertes) :
    ```json
    {
      "type_mouvement": "Perte_Gaspillage",
      "produit_id": "xxx",
      "quantite": 5,
      "motif": "P√©rim√©",
      "date_peremption": "2025-04-20",
      "reference_restauration": "perte_id_xyz"
    }
    ```

#### 6.2 Int√©gration Module Finances/Comptabilit√©
- **Export donn√©es** :
  - `POST /api/finances/recettes_restauration` ‚Üí Envoyer recettes valid√©es
  - `GET /api/finances/categories_tickets` ‚Üí R√©cup√©rer si li√© ailleurs
- **R√©conciliation** : Rapport mensuel comparatif

#### 6.3 Int√©gration Calendrier Acad√©mique
- R√©cup√©rer dates de cong√©s/fermetures pour afficher menus inactifs
- Adapter tarifs si n√©cessaire (p√©riodes sp√©ciales)

---

## üóÑÔ∏è STRUCTURE DES DONN√âES / MOD√àLES

### Menus
```
- menu_id (UUID, PK)
- nom_menu (string, 255)
- type_service (ENUM: Petit_D√©jeuner, D√©jeuner, D√Æner)
- date_application (DATE)
- statut (ENUM: Actif, Inactif, Planifi√©)
- description (TEXT)
- created_at, updated_at
```

### D√©tails Menus (Many-to-Many)
```
- detail_menu_id (UUID, PK)
- menu_id (FK)
- produit_id (FK vers Stock)
- quantite_unitaire (DECIMAL)
- unite_mesure (string: kg, litre, portion, etc.)
- co√ªt_unitaire (DECIMAL, FCFA)
- ordre_affichage (INT)
```

### Cat√©gories de Tickets
```
- categorie_ticket_id (UUID, PK)
- nom_categorie (string, 255)
- type_service (ENUM)
- prix_unitaire (DECIMAL, FCFA)
- statut (ENUM: Actif, Inactif)
- description (TEXT)
- created_at, updated_at
```

### Tickets
```
- ticket_id (UUID, PK)
- categorie_ticket_id (FK)
- date_emission (DATETIME)
- date_consommation (DATE)
- type_service (ENUM)
- quantite (INT)
- prix_unitaire (DECIMAL, FCFA)
- montant_total (DECIMAL, FCFA) ‚Üí calcul√©
- statut_validation (ENUM: Non_Valid√©, Valid√©, Encaiss√©)
- emis_par (FK User)
- notes (TEXT)
- created_at, updated_at
```

### Besoins Quotidiens
```
- besoin_id (UUID, PK)
- date (DATE)
- type_service (ENUM)
- menu_id (FK)
- nombre_rationnaires_prevus (INT)
- statut (ENUM: Brouillon, Valid√©, Stock_D√©duit, Consomm√©)
- valid√©_par (FK User, nullable)
- date_validation (DATETIME, nullable)
- created_at, updated_at
```

### D√©tails Besoins
```
- detail_besoin_id (UUID, PK)
- besoin_id (FK)
- produit_id (FK Stock)
- ration_unitaire (DECIMAL)
- quantite_totale (DECIMAL) ‚Üí calcul√©e
- stock_disponible (DECIMAL) ‚Üí synchronis√©
- statut_disponibilite (ENUM: OK, Insuffisant)
```

### Consommation
```
- consommation_id (UUID, PK)
- besoin_id (FK)
- date (DATE)
- type_service (ENUM)
- nombre_rationnaires_servis (INT)
- statut (ENUM: Servi, Non_Servi, Partiellement_Servi)
- notes (TEXT)
- created_at, updated_at
```

### Pertes/Gaspillage
```
- perte_id (UUID, PK)
- date_constatation (DATETIME)
- produit_id (FK Stock)
- quantite_perdue (DECIMAL)
- unite_mesure (string)
- motif (ENUM: P√©rim√©, Gaspillage, D√©t√©rioration, Autre)
- date_peremption (DATE, nullable)
- description_detaillee (TEXT)
- value_fcfa (DECIMAL) ‚Üí quantit√© √ó prix
- created_at, updated_at
```

---

## üé® INTERFACES UTILISATEUR (Description)

### 1. Tableau de Bord Restauration
- **Vue d'ensemble** : R√©capitulatif jour + mois
- **Widgets** :
  - Fr√©quentation actuelle
  - Recettes du jour
  - √âtat stock (alertes)
  - Pertes du jour
- **Acc√®s rapide** : Boutons vers gestion menus, tickets, besoins, pertes

### 2. Gestion des Menus
- **Liste des menus** : Tableau avec filtres (date, type_service, statut)
- **Cr√©ation/√âdition** : 
  - Formulaire basique (nom, type_service, date)
  - Tableau dynamique pour ajouter produits (search + qty)
  - Calcul auto du co√ªt total
  - Aper√ßu des rations par rationnaire
- **Calendrier visuel** : Vue mois/semaine avec menus assign√©s
- **Actions** : Dupliquer, Inactiver, Pr√©visualiser

### 3. Gestion des Tickets
- **Liste des cat√©gories** : CRUD simple pour cat√©gories
- **√âmission de tickets** :
  - S√©lection type_service + cat√©gorie_ticket
  - Saisie quantit√©
  - Affichage montant total
  - Bouton "√âmettre tickets"
- **Historique tickets** : Tableau avec filtres (date, statut, cat√©gorie)
- **Rapprochement** : Comparaison tickets √©mis vs encaissements

### 4. Besoins Quotidiens
- **Nouvelle fiche** :
  - S√©lection date, type_service, menu
  - Saisie nombre rationnaires pr√©vus
  - Affichage automatique produits requis
  - Tableau des besoins avec statut stock
  - **BOUTON ROUGE "Valider & D√©duire du Stock"** avec confirmation
- **Historique fiches** : Tableau avec statuts
- **Aper√ßu d√©ductions** : Journal des appels API verso Stock

### 5. Gestion des Pertes
- **Nouvelle perte** :
  - S√©lection produit (search)
  - Saisie quantit√© perdue + motif
  - Champ date_peremption (si p√©rim√©)
  - Zone texte description d√©taill√©e
  - Upload photo (optionnel)
  - Calcul automatique valeur FCFA
- **Historique** : Tableau avec filtres (motif, date, produit)
- **Statistiques** : % gaspillage par produit, co√ªt total pertes

### 6. Rapports & Exports
- **Page Rapports** :
  - S√©lecteurs : Plage de dates, Type rapport (Journalier/Mensuel/Annuel)
  - **Vue tableau** : Synth√®se d√©taill√©e
  - **Vue graphiques** : Courbes recettes, histogrammes fr√©quentation
  - **Boutons export** : 
    - "Exporter en PDF" (mise en forme professionnelle)
    - "Exporter en Excel" (donn√©es brutes + graphiques)
- **Rapports pr√©-g√©n√©r√©s** : Flux automatique pour derniers 7 jours, 30 jours, ann√©e

### 7. Param√®tres Restauration
- Gestion tarifs par type_service (edit prix)
- Configuration seuils alerte (coordonn√©e avec Stock)
- Gestion calendrier sp√©cial (cong√©s, fermetures)

---

## üîå INT√âGRATIONS TECHNIQUES

### API Endpoints √† Cr√©er

#### Menus
```
GET    /api/restauration/menus?date=YYYY-MM-DD&type_service=...
POST   /api/restauration/menus
GET    /api/restauration/menus/{menu_id}
PUT    /api/restauration/menus/{menu_id}
DELETE /api/restauration/menus/{menu_id}
GET    /api/restauration/menus/{menu_id}/details
```

#### Tickets
```
GET    /api/restauration/tickets?date_from=...&date_to=...
POST   /api/restauration/tickets
GET    /api/restauration/tickets/{ticket_id}
PATCH  /api/restauration/tickets/{ticket_id}/valider
GET    /api/restauration/categories-tickets
POST   /api/restauration/categories-tickets
```

#### Besoins
```
GET    /api/restauration/besoins?date=...&type_service=...
POST   /api/restauration/besoins
GET    /api/restauration/besoins/{besoin_id}
POST   /api/restauration/besoins/{besoin_id}/deduire-stock
PATCH  /api/restauration/besoins/{besoin_id}/valider
```

#### Consommation
```
POST   /api/restauration/consommation
GET    /api/restauration/consommation?date=...
PATCH  /api/restauration/consommation/{consommation_id}
```

#### Pertes
```
POST   /api/restauration/pertes
GET    /api/restauration/pertes?date_from=...&date_to=...
GET    /api/restauration/pertes/statistiques?mois=...
DELETE /api/restauration/pertes/{perte_id}
```

#### Rapports
```
GET    /api/restauration/rapports/journalier?date=YYYY-MM-DD
GET    /api/restauration/rapports/mensuel?mois=YYYY-MM
GET    /api/restauration/rapports/annuel?annee=YYYY
POST   /api/restauration/rapports/export-pdf
POST   /api/restauration/rapports/export-excel
```

---

## üìà PHASES D'IMPL√âMENTATION

### Phase 1 : Fondations (Priorit√© 1)
- [ ] Mod√®les & migrations (Menus, Cat√©gories Tickets, Besoins)
- [ ] API CRUD de base
- [ ] Interface gestion menus (calendrier simple)
- [ ] Interface √©mission tickets

### Phase 2 : Int√©gration Stock (Priorit√© 1)
- [ ] Endpoint d√©duction stock avec validation
- [ ] Gestion des erreurs & rollback
- [ ] Fiche besoins quotidiens (display + bouton d√©duction)
- [ ] Historique des mouvements

### Phase 3 : Pertes & Suivi (Priorit√© 2)
- [ ] Gestion pertes/gaspillage
- [ ] Synchronisation vers Stock
- [ ] Statistiques gaspillage

### Phase 4 : Rapports & Export (Priorit√© 2)
- [ ] Rapports journalier/mensuel/annuel
- [ ] Export PDF professionnel
- [ ] Export Excel
- [ ] Dashboard avec widgets

### Phase 5 : Polish & Synchronisation Finances (Priorit√© 3)
- [ ] Int√©gration finale module Finances
- [ ] Tableaux de bord am√©lior√©s
- [ ] Notifications/alertes
- [ ] Tests & optimisations

---

## ‚úÖ CRIT√àRES DE SUCC√àS

- ‚úÖ Menus vari√©s g√©rables avec composition produits d√©taill√©e
- ‚úÖ D√©duction du stock **valid√©e manuellement** via bouton
- ‚úÖ Synchronisation bidirectionnelle avec module Stock (API)
- ‚úÖ Gestion des pertes + gaspillage integrated dans Stock
- ‚úÖ Rapports situation (journali√®re, mensuelle, annuelle) disponibles
- ‚úÖ Exports PDF/Excel fonctionnels
- ‚úÖ Dashboard int√©gr√© aux dashboards existants
- ‚úÖ Syst√®me de cat√©gories tickets flexible
- ‚úÖ Aucune perte de donn√©es lors des synchronisations
- ‚úÖ Tra√ßabilit√© compl√®te des mouvements

---

## üìù Notes Additionnelles

1. **Tarifs** : Actuels = 150 FCFA (Petit d√©j), 350 FCFA (D√©j & D√Æner) ‚Üí √Ä param√©trer
2. **Devises** : FCFA uniquement
3. **Langues** : Fran√ßais prioritaire
4. **Permissions** : √Ä d√©finir (Admin, Agent Resto, Responsable Resto, Comptable)
5. **Audit** : Logger tous les mouvements (qui, quoi, quand, changements)
6. **S√©curit√©** : Valider les quantit√©s, emp√™cher montants n√©gatifs, authentification requise

---

**Document g√©n√©r√© le** : 2025-04-24
**Version** : 1.0 Final